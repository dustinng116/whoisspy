<div class="app-container">

    <!-- ================= HOME SCREEN ================= -->
    @if (!joined()) {
    <div class="screen-home fade-in">
        <div class="fingerprint-icon">
            <!-- <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="#6c5ce7" stroke-width="1.5"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 12C2 6.5 6.5 2 12 2a10 10 0 0 1 8 6" />
                <path d="M5 19.5C5.5 18 6 15 6 12a6 6 0 0 1 .34-2" />
                <path d="M8.65 22c.21-.66.45-1.32.57-2" />
                <path d="M9 6.8a6 6 0 0 1 9 5.2c0 .47 0 .95-.07 1.43" />
                <path d="M16 22h1.8" />
                <path d="M13 22.4c-.05-1-.26-2-.35-3" />
                <path d="M9 12.5a4.5 4.5 0 0 1 6.8-2.6" />
            </svg> -->
            <img src="assets/spy.png" alt="Spy" width="80%" />
        </div>
        <h1>Who is the Spy?</h1>
        <div class="input-group">
            <input [ngModel]="playerName()" (ngModelChange)="onNameInput($event)" [class.input-error]="isNameError()"
                placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." />
        </div>

        @if (viewMode() === 'home') {
        <button class="btn-primary" (click)="createRoom()">T·∫†O PH√íNG</button>
        <button class="btn-secondary " style="margin-top: 1rem;" (click)="viewMode.set('join_input')">THAM GIA V√ÄO PH√íNG
            ‚Üí</button>
        } @else {
        <div class="input-group fade-in">
            <label>ROOM ID</label>
            <input type="text" placeholder="Nh·∫≠p 8 s·ªë m√£ ph√≤ng..." [value]="joinRoomInput()"
                (input)="onRoomInput($event)" [class.input-error]="isRoomError()" autofocus />
        </div>

        <div class="row-btn">
            <button class="btn-primary" [disabled]="joinRoomInput().length !== 8" (click)="joinRoom()">
                V√ÄO NGAY
            </button>
            <button class="btn-text" (click)="viewMode.set('home')">Quay l·∫°i</button>
        </div>
        }
    </div>
    }

    <!-- ================= JOINED ================= -->
    @if (joined()) {

    <!-- ===== ROLE OVERLAY / MAIN SCREEN ===== -->
    @if (showWord()) {
    <div class="role-overlay fade-in">
        <div class="role-card">
            <!-- <div class="role-header">VAI TR√í C·ª¶A B·∫†N</div>
            <h1 class="role-name" [class.spy]="myRoleRaw() === 'spy'">
                {{ myRoleRaw() === 'spy' ? 'GI√ÅN ƒêI·ªÜP' : 'D√ÇN TH∆Ø·ªúNG' }}
            </h1>

            <div class="role-icon">
                @if(myRoleRaw() === 'spy') { üïµÔ∏è‚Äç‚ôÇÔ∏è } @else { üë§ }
            </div> -->

            <h1>Who is the Spy?</h1>
            <p class="role-hint">T·ª´ b√≠ m·∫≠t c·ªßa b·∫°n l√†:</p>
            <div class="secret-word-row">
                <div class="secret-word" [class.hidden]="!isWordVisible()">
                    {{ isWordVisible() ? myWord() : '******' }}
                </div>

                <button class="btn-eye" (click)="toggleWordVisibility()">
                    {{ isWordVisible() ? 'üôà' : 'üëÅÔ∏è' }}
                </button>
            </div>
            <p class="role-sub">H√£y ghi nh·ªõ t·ª´ n√†y v√† ƒë·ª´ng ƒë·ªÉ l·ªô!</p>
        </div>

        <button class="btn-primary large ready-btn" (click)="acknowledgeRole()">
            S·∫¥N S√ÄNG ‚úì
        </button>
        <p class="waiting-text">ƒêANG CH·ªú NG∆Ø·ªúI CH∆†I KH√ÅC...</p>
    </div>
    } @else {
    <div class="screen-main fade-in">

        <div class="main-header">
            @if (isLobby()) {
            <div class="room-info-group">
                <span class="label">PH√íNG CH·ªú</span>
                <div class="code-wrapper">
                    <h1 class="room-id">#{{ roomId() }}</h1>
                    <button class="btn-copy" (click)="copyRoomId()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2-2h2"></path>
                        </svg>
                    </button>

                    <button class="btn-icon qr-btn" (click)="toggleQr(true)" title="Hi·ªán m√£ QR">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                    </button>
                </div>
            </div>
            @if (isHost()) {
            <div class="host-pill-card">
                <div class="icon-shield">üëë</div>
                <div class="info">
                    <span class="role-label">CH·ª¶ PH√íNG</span>
                    <span class="host-name">B·∫°n ({{ playerName() }})</span>
                </div>
            </div>
            }
            }

            @if (isVoting()) {
            <div class="vote-header fade-in">
                <div class="timer-pill">‚è± {{ voteCountdown() }}s</div>
                <h2>Who is the <span class="spy-text">Spy?</span></h2>
                <p>Ch·ªçn ng∆∞·ªùi ƒë√°ng ng·ªù nh·∫•t!</p>
            </div>
            }
            @if (isDiscussion()) {
            <div class="playing-header fade-in">
                <h2>üó£Ô∏è ƒêang th·∫£o lu·∫≠n</h2>
                <p>H√£y t√¨m ra k·∫ª gi·∫£ m·∫°o!</p>

                <div class="keyword-review-box" (click)="toggleReviewKeyword()" [class.active]="isReviewingKeyword()">
                    <span class="icon">üîë</span>
                    <span class="content">
                        {{ isReviewingKeyword() ? myWord() : 'Xem l·∫°i t·ª´ kh√≥a' }}
                    </span>
                    <span class="eye-mini">{{ isReviewingKeyword() ? 'üôà' : 'üëÅÔ∏è' }}</span>
                </div>

                @if (!isEliminated()) {
                <button class="btn-spy-guess fade-in mt-20" (click)="openGuessModal()">
                    üéØ ƒêo√°n t·ª´ (Win ngay)
                </button>
                }
            </div>
            }
        </div>

        <div class="player-grid">
            @for (slot of playersSlots(); track $index) {
            @if (slot) {
            <div class="card player-card" [class.selectable]="isVoting() && !slot.eliminated && slot.id !== playerId"
                [class.offline]="!slot.isOnline" [class.selected]="selectedVoteId() === slot.id"
                [class.eliminated]="slot.eliminated" [class.is-me]="slot.id === playerId"
                [class.self-voting]="isVoting() && slot.id === playerId"
                (click)="isVoting() ? selectForVote(slot.id) : onAvatarClick(slot)">

                @if (selectedVoteId() === slot.id) { <div class="check-circle">‚úì</div> }
                @if (isVoting() && getVoteDots(slot.id).length > 0) {
                <div class="vote-dots-container">
                    @for(dot of getVoteDots(slot.id); track $index) { <span class="vote-dot"></span> }
                </div>
                }

                <div class="avatar-box" [class.has-image]="slot.avatar"
                    [style.background-color]="slot.avatar ? 'transparent' : getAvatarColor(slot.name)">
                    @if (slot.id === playerId) {
                    <div class="me-badge">B·∫†N</div>
                    }
                    @if (slot.avatar) {
                    <img [src]="'assets/avatars/' + slot.avatar" alt="Avatar" class="avatar-img" />
                    } @else {
                    {{ slot.name.substring(0,2).toUpperCase() }}
                    }
                    @if (slot.id === playerId && isLobby()) {
                    <div class="edit-badge">‚úèÔ∏è</div>
                    }
                </div>

                <div class="info-box">
                    <div class="p-name">{{ slot.name }} @if (slot.id === room().hostId) { <span
                            class="txt-host">üëë</span> }</div>
                    <div class="p-role">
                        @if (!slot.isOnline) {
                        <span class="txt-offline">OFFLINE üî¥</span>
                        }
                        @else if (slot.eliminated) {
                        <span class="txt-dead">ƒê√É LO·∫†I</span>
                        }
                        @else if (isLobby()) {
                        <span class="txt-ready">S·∫¥N S√ÄNG</span>
                        }
                    </div>
                </div>


            </div>
            }
            @else {
            @if (isLobby()) {
            <div class="card empty-slot">
                <div class="txt-empty">Tr·ªëng</div>
            </div>
            }
            }
            }
        </div>

        <div class="footer-actions">

            @if (isLobby()) {
            <div class="left-group">
                <button class="btn-white" (click)="openSettings()">
                    <span>‚öôÔ∏è</span> C√†i ƒë·∫∑t game
                </button>
                <button class="btn-exit" (click)="exitGame()">
                    <span>‚ùå</span> Tho√°t
                </button>
            </div>

            <div class="right-group">
                @if (isHost()) {
                <div class="start-hint">
                    <strong>S·∫µn s√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu?</strong>
                    <span>C·∫ßn t·ªëi thi·ªÉu {{ minRequiredPlayers() }} ng∆∞·ªùi ch∆°i</span>
                </div>

                <button class="btn-start" [ngClass]="playerCount() < minRequiredPlayers() ? 'disabled' : ''"
                    [disabled]="playerCount() < minRequiredPlayers()" (click)="startGame()">
                    B·∫ÆT ƒê·∫¶U GAME ‚ñ∂
                </button>
                } @else {
                <button class="btn-start disabled" disabled>ƒêang ch·ªù ch·ªß ph√≤ng...</button>
                }
            </div>
            }


            @if (isDiscussion() && isHost()) {
            <div class="center-group fade-in">
                <button class="btn-primary vote-btn" (click)="startVoting()">
                    B·∫ÆT ƒê·∫¶U VOTE ‚ö°
                </button>
            </div>
            }

            @if (isVoting()) {
            <div class="center-group fade-in">
                <button class="btn-primary confirm-btn" [disabled]="!selectedVoteId()" (click)="confirmVote()">
                    X√ÅC NH·∫¨N ‚Üí
                </button>
            </div>
            }
        </div>
    </div>
    }
    @if (showQrModal()) {
    <div class="modal-backdrop fade-in" (click)="toggleQr(false)">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h3>Qu√©t m√£ ƒë·ªÉ tham gia</h3>
            <div class="qr-container">
                @if (qrCodeUrl()) {
                <img [src]="qrCodeUrl()" alt="Room QR Code" />
                }
            </div>
            <p class="room-hint">Ph√≤ng: <strong>#{{ roomId() }}</strong></p>
            <button class="btn-primary" (click)="toggleQr(false)">ƒê√≥ng</button>
        </div>
    </div>
    }
    <!-- @if (isSpyGuessing()) {
    <div class="modal-backdrop fade-in" (click)="closeSpyGuess()">
        <div class="modal-content spy-modal" (click)="$event.stopPropagation()">
            <h3>üïµÔ∏è‚Äç‚ôÇÔ∏è SPY GUESS</h3>
            <p>N·∫øu b·∫°n ƒëo√°n ƒë√∫ng t·ª´ kh√≥a c·ªßa D√¢n Th∆∞·ªùng, b·∫°n s·∫Ω th·∫Øng ngay l·∫≠p t·ª©c!</p>

            <input class="spy-input" placeholder="Nh·∫≠p t·ª´ b√≠ m·∫≠t..." [ngModel]="spyGuessInput()"
                (ngModelChange)="spyGuessInput.set($event)" autofocus />

            <div class="modal-actions">
                <button class="btn-white" (click)="closeSpyGuess()">H·ªßy</button>
                <button class="btn-primary" (click)="submitSpyGuess()">ƒêo√°n ngay</button>
            </div>
        </div>
    </div>
    } -->
    @if (showDrawModal()) {
    <div class="modal-backdrop fade-in">
        <div class="modal-content result-modal">
            <div class="skull-icon">‚öñÔ∏è</div>
            <h1 class="eliminated-name" style="color: #f1c40f">H√íA VOTE</h1>
            <p>S·ªë phi·∫øu b·∫±ng nhau. Kh√¥ng ai b·ªã lo·∫°i!</p>
        </div>
    </div>
    }
    @if (showAvatarModal()) {
    <div class="modal-backdrop fade-in" (click)="showAvatarModal.set(false)">
        <div class="modal-content avatar-modal" (click)="$event.stopPropagation()">

            @if (previewAvatar()) {
            <div class="preview-mode fade-in">
                <h3>XEM TR∆Ø·ªöC</h3>

                <div class="preview-box">
                    <img [src]="'assets/avatars/' + previewAvatar()" alt="Preview" />
                </div>

                <div class="action-row">
                    <button class="btn-white" (click)="backToList()">
                        ‚Üê Ch·ªçn h√¨nh kh√°c
                    </button>
                    <button class="btn-primary" (click)="confirmAvatar()">
                        X√°c nh·∫≠n ‚úì
                    </button>
                </div>
            </div>
            }

            @else {
            <div class="list-mode fade-in">
                <h3>ƒê·ªîI AVATAR</h3>
                <p class="hint">Ch·ªçn m·ªôt h√¨nh ƒë·ªÉ xem tr∆∞·ªõc</p>

                <div class="avatar-list-grid">
                    @for (img of AVATAR_LIST; track $index) {
                    <div class="avatar-option small" (click)="openPreview(img)">
                        <img [src]="'assets/avatars/' + img" loading="lazy" />
                    </div>
                    }
                </div>

                <button class="btn-white mt-20" (click)="showAvatarModal.set(false)">ƒê√≥ng</button>
            </div>
            }

        </div>
    </div>
    }
    @if (isGuessing()) {
    <div class="modal-backdrop fade-in" (click)="closeGuessModal()">
        <div class="modal-content spy-modal" (click)="$event.stopPropagation()">
            <h3>üéØ QUY·∫æT ƒê·ªäNH T√ÅO B·∫†O</h3>

            <p style="font-size: 13px; color: #636e72;">
                B·∫°n s·∫Ω ƒëo√°n t·ª´ kh√≥a c·ªßa <strong>phe ƒë·ªëi th·ªß</strong>.<br>
                <span style="color: #ff4757; font-weight: bold;">C·∫¢NH B√ÅO:</span>
                N·∫øu ƒëo√°n SAI, phe b·∫°n s·∫Ω <strong style="color: #ff4757">THUA NGAY L·∫¨P T·ª®C</strong>!
            </p>

            <input class="spy-input" placeholder="Nh·∫≠p t·ª´ kh√≥a..." [ngModel]="guessInput()"
                (ngModelChange)="guessInput.set($event)" autofocus />

            <div class="modal-actions">
                <button class="btn-white" (click)="closeGuessModal()">H·ªßy</button>
                <button class="btn-primary" (click)="submitGuess()">Ch·ªët ƒë∆°n</button>
            </div>
        </div>
    </div>
    }

    @if (showResultModal()) {
    <div class="modal-backdrop fade-in" (click)="isGameOver() ? null : closeResultModal()">
        <div class="modal-content result-modal" (click)="$event.stopPropagation()">

            @if (isGameOver()) {
            <div class="skull-icon">
                {{ winner() === 'spy' ? 'üèÜ' : randomEmoji() }} </div>

            <h3>K·∫æT TH√öC GAME</h3>

            <h1 class="eliminated-name" [style.color]="winner() === 'spy' ? '#ff4757' : '#0984e3'">
                {{ winner() === 'spy' ? 'GI√ÅN ƒêI·ªÜP TH·∫ÆNG' : 'D√ÇN TH∆Ø·ªúNG TH·∫ÆNG' }}
            </h1>

            <div class="reason-box">
                @if (endReason() === 'guessed_correct') {
                <p><strong>{{ heroName() }}</strong> ƒë√£ xu·∫•t s·∫Øc ƒëo√°n ƒë√∫ng t·ª´ kh√≥a!</p>
                }
                @else if (endReason() === 'guessed_wrong') {
                <p><strong>{{ heroName() }}</strong> ƒë√£ ƒëo√°n sai v√† "b√°o" c·∫£ team! ü§£</p>
                }
                @else if (endReason() === 'not_enough_players') {
                <p style="color: #e67e22; font-weight: bold;">
                    ‚ö†Ô∏è Game b·ªã h·ªßy do kh√¥ng ƒë·ªß ng∆∞·ªùi ch∆°i!
                </p>
                <p class="small-text">(C√°c ng∆∞·ªùi ch∆°i kh√°c ƒë√£ tho√°t)</p>
                }
                @else if (endReason() === 'player_left') {
                <p>
                    {{ winner() === 'spy' ? 'D√¢n th∆∞·ªùng' : 'Gi√°n ƒëi·ªáp' }} ƒë√£ b·ªè ch·∫°y! üèÉ‚Äç‚ôÇÔ∏èüí®
                </p>
                <p>Chi·∫øn th·∫Øng thu·ªôc v·ªÅ phe c√≤n l·∫°i!</p>
                }
                @else {
                <p>Gi√°n ƒëi·ªáp ƒë√£ b·ªã lo·∫°i h·∫øt!</p>
                }
            </div>

            <div class="spy-reveal-section">
                <p class="reveal-label">DANH T√çNH GI√ÅN ƒêI·ªÜP:</p>
                <div class="spy-list">
                    @for (spy of spiesList(); track $index) {
                    <div class="spy-card-mini">
                        <div class="avatar-mini" [style.background-color]="getAvatarColor(spy.name)">
                            {{ spy.name.substring(0,2).toUpperCase() }}
                        </div>
                        <span class="spy-name">{{ spy.name }}</span>
                    </div>
                    }
                </div>
            </div>

            @if (isHost()) {
            <button class="btn-primary mt-20" (click)="backToLobby()">üîÑ Ch∆°i v√°n m·ªõi</button>
            } @else {
            <p class="waiting-text">Ch·ªù ch·ªß ph√≤ng...</p>
            }

            } @else {
            <div class="skull-icon">‚ò†Ô∏è</div>
            <h3>NG∆Ø·ªúI B·ªä LO·∫†I</h3>
            <h1 class="eliminated-name">{{ room().game.revealedPlayer.id === playerId ? 'B·∫†N' :
                room().players[room().game.revealedPlayer.id]?.name }}</h1>
            @if(room().game.revealedPlayer.id === playerId){
            <div class="identity-box">
                L√†: <strong [class.spy]="room().game.revealedPlayer.role === 'spy'">
                    {{ room().game.revealedPlayer.role === 'spy' ? 'gI√ÅN ƒêI·ªÜP' : 'D√ÇN TH∆Ø·ªúNG' }}
                </strong>
            </div>
            }

            <button class="btn-primary mt-20" (click)="closeResultModal()">ƒê√≥ng (5s)</button>
            }

        </div>
    </div>
    }
    @if (viewingUser()) {
    <div class="modal-backdrop fade-in" (click)="closeViewUser()">
        <div class="modal-content avatar-view-modal" (click)="$event.stopPropagation()">

            <h3 class="user-name-title">{{ viewingUser().name }}</h3>

            <div class="preview-box large">
                @if (viewingUser().avatar) {
                <img [src]="'assets/avatars/' + viewingUser().avatar" alt="User Avatar" />
                } @else {
                <div class="fallback-avatar" [style.background-color]="getAvatarColor(viewingUser().name)">
                    {{ viewingUser().name.substring(0,2).toUpperCase() }}
                </div>
                }
            </div>

            <button class="btn-white mt-20" (click)="closeViewUser()">ƒê√≥ng</button>
        </div>
    </div>
    }


    @if (showSettingsModal()) {
    <div class="modal-backdrop fade-in" (click)="closeSettings()">
        <div class="modal-content settings-modal" (click)="$event.stopPropagation()">
            <h3>‚öôÔ∏è C√ÄI ƒê·∫∂T PH√íNG</h3>

            <div class="settings-form">
                <div class="config-section">
                    <label>‚è±Ô∏è Th·ªùi gian Vote:</label>
                    <div class="time-options">
                        @for (time of timeOptions; track time) {
                        <button class="btn-time" [class.active]="tempVoteDuration() === time"
                            (click)="tempVoteDuration.set(time)">
                            {{ time }}s
                        </button>
                        }
                    </div>
                </div>
                <div class="form-group">
                    <label>S·ªë l∆∞·ª£ng Gi√°n ƒêi·ªáp (Spy)</label>
                    <div class="select-wrapper">
                        <select [ngModel]="tempSpyCount()" (ngModelChange)="tempSpyCount.set(+$event)">
                            <option [value]="1">1 Spy (C·ªï ƒëi·ªÉn)</option>
                            <option [value]="2">2 Spies (ƒê√¥ng vui)</option>
                            <option [value]="3">3 Spies (H·ªón lo·∫°n)</option>
                        </select>
                    </div>
                    <p class="hint-text">
                        L∆∞u √Ω: Ch·∫ø ƒë·ªô {{ tempSpyCount() }} Spy c·∫ßn √≠t nh·∫•t
                        <strong>{{ tempMinRequired() }} ng∆∞·ªùi ch∆°i</strong>.
                    </p>
                </div>

                <div class="form-group row-between">
                    <label>Cho ph√©p ƒë·ªïi Vote?</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="voteChange" [ngModel]="tempAllowVoteChange()"
                            (ngModelChange)="tempAllowVoteChange.set($event)">
                        <label for="voteChange" class="slider"></label>
                    </div>
                </div>

            </div>

            <div class="modal-actions">
                <button class="btn-white" (click)="closeSettings()">H·ªßy</button>
                @if (isHost()) {
                <button class="btn-primary" (click)="saveSettings()">L∆∞u C√†i ƒê·∫∑t</button>
                } @else {
                <button class="btn-primary" disabled>Ch·ªâ Host ch·ªânh ƒë∆∞·ª£c</button>
                }
            </div>
        </div>
    </div>
    }
    }
    @if (showErrorModal()) {
    <div class="modal-backdrop fade-in" (click)="closeErrorModal()">
        <div class="modal-content error-modal" (click)="$event.stopPropagation()">

            <div class="icon-warning">‚ö†Ô∏è</div>

            <h3>R·∫§T TI·∫æC!</h3>

            <p class="error-msg">{{ errorMessage() }}</p>

            <button class="btn-primary mt-20" (click)="closeErrorModal()">ƒê√£ hi·ªÉu</button>
        </div>
    </div>
    }
</div>